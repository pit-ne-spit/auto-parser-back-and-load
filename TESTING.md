# Инструкция по тестированию модулей загрузки данных

## Подготовка к тестированию

### 1. Проверка окружения

Убедитесь, что все зависимости установлены:
```bash
pip install -r requirements.txt
```

### 2. Настройка переменных окружения

Проверьте файл `.env` - должны быть установлены:
```env
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=ваш_пароль
DB_NAME=che168_db
CHE168_API_KEY=ваш_api_ключ
CHE168_ACCESS_NAME=autobase
```

### 3. Проверка подключения к БД

```bash
python scripts/test_db_connection.py
```

Если база данных не существует, создайте её:
```sql
CREATE DATABASE che168_db;
```

### 4. Применение миграций

```bash
alembic upgrade head
```

---

## Тестирование

### Вариант 1: Комплексное тестирование (рекомендуется)

Запустите комплексный тест, который проверит оба модуля:

```bash
python scripts/test_loaders.py
```

Этот скрипт:
1. Проверит подключение к БД
2. Покажет текущее состояние БД
3. Выполнит тестовую первоначальную загрузку (2 страницы)
4. Покажет результаты
5. Выполнит тестовое ежедневное обновление (1 день)
6. Покажет финальные результаты

### Вариант 2: Раздельное тестирование

#### Тест первоначальной загрузки

```bash
# Тестовая загрузка (2 страницы = ~40 записей)
python scripts/initial_load.py --max-pages 2

# Тестовая загрузка (5 страниц = ~100 записей)
python scripts/initial_load.py --max-pages 5

# Полная загрузка (без ограничений - НЕ РЕКОМЕНДУЕТСЯ для первого теста)
python scripts/initial_load.py
```

**Ожидаемый результат:**
- Загрузка данных из API CHE168
- Сохранение в таблицу `raw_data`
- Прогресс-бар в консоли
- Статистика в конце: количество страниц, загруженных записей, пропущенных дубликатов, ошибок

#### Тест ежедневного обновления

```bash
# Тестовое обновление (1 день)
python scripts/daily_update.py --max-dates 1

# Тестовое обновление (3 дня)
python scripts/daily_update.py --max-dates 3

# Полное обновление (все пропущенные дни)
python scripts/daily_update.py
```

**Ожидаемый результат:**
- Определение пропущенных дней из `sync_state`
- Получение изменений через `/change_id` и `/changes`
- Обработка разных типов изменений (added, changed, removed)
- Обновление `sync_state`
- Статистика: даты, загруженные записи, обновленные, удаленные, ошибки

---

## Проверка результатов

### Проверка данных в БД

Подключитесь к PostgreSQL и выполните запросы:

```sql
-- Общее количество записей
SELECT COUNT(*) FROM raw_data;

-- По источнику
SELECT source, COUNT(*) FROM raw_data GROUP BY source;

-- По статусу активности
SELECT active_status, COUNT(*) FROM raw_data GROUP BY active_status;

-- По статусу обработки
SELECT is_processed, COUNT(*) FROM raw_data GROUP BY is_processed;

-- Последние записи
SELECT inner_id, mark, model, year, price, source, active_status, is_processed 
FROM raw_data 
ORDER BY first_loaded_at DESC 
LIMIT 10;

-- Состояние синхронизации
SELECT * FROM sync_state;

-- Логи операций
SELECT * FROM operations_log ORDER BY started_at DESC LIMIT 10;
```

### Проверка логов

Все операции логируются в `logs/app.log`:

```bash
# Последние 50 строк логов
tail -n 50 logs/app.log

# Поиск ошибок
grep ERROR logs/app.log

# Поиск операций загрузки
grep "data_fetch" logs/app.log
```

---

## Типичные проблемы и решения

### Проблема: "Database does not exist"

**Решение:**
```sql
CREATE DATABASE che168_db;
```

### Проблема: "Invalid password" или "Connection refused"

**Решение:**
- Проверьте настройки в `.env`
- Убедитесь, что PostgreSQL запущен
- Проверьте правильность пароля

### Проблема: "CHE168_API_KEY is not set"

**Решение:**
- Добавьте `CHE168_API_KEY` в `.env`
- Убедитесь, что файл `.env` находится в корне проекта

### Проблема: "No module named 'app'"

**Решение:**
- Убедитесь, что вы запускаете скрипт из корня проекта
- Или используйте абсолютный путь

### Проблема: API возвращает ошибку

**Решение:**
- Проверьте правильность `CHE168_API_KEY` и `CHE168_ACCESS_NAME`
- Убедитесь, что API доступен
- Проверьте логи для деталей ошибки

---

## Ожидаемое поведение

### Первоначальная загрузка

1. Скрипт начинает с первой страницы
2. Загружает данные через API
3. Сохраняет в `raw_data` с `source = "initial_load"`
4. Пропускает дубликаты (по `inner_id`)
5. Продолжает до последней страницы или до достижения `max_pages`
6. Выводит прогресс-бар в консоль
7. Записывает операцию в `operations_log`

### Ежедневное обновление

1. Скрипт проверяет `sync_state` для определения последней успешной даты
2. Если записей нет - начинает с сегодняшней даты
3. Для каждой пропущенной даты:
   - Получает `change_id` через `/change_id?date=...`
   - Обрабатывает все страницы изменений через `/changes?change_id=...`
   - Обрабатывает типы изменений:
     - `added` → создание новой записи
     - `changed` → обновление существующей (merge JSON)
     - `removed` → установка `active_status = 1`
4. Обновляет `sync_state` после успешной обработки каждого дня
5. Записывает операцию в `operations_log`

---

## Следующие шаги после успешного тестирования

После успешного тестирования можно:

1. **Запустить нормализацию данных:**
   ```bash
   python scripts/normalize.py --batch-size 50
   ```

2. **Проверить нормализованные данные:**
   ```sql
   SELECT COUNT(*) FROM processed_data;
   SELECT * FROM processed_data LIMIT 5;
   ```

3. **Подготовиться к полной загрузке:**
   - Убедитесь, что есть достаточно места на диске
   - Подготовьте мониторинг процесса
   - Запустите полную загрузку: `python scripts/initial_load.py`
