# Обогащение словаря переводов

## Описание

Набор скриптов для автоматизации процесса обогащения словаря переводов с китайского на русский язык. Процесс включает извлечение непереведенных значений, добавление переводов в словарь и повторную нормализацию данных.

## Итеративный процесс (Рекомендуемый)

Для полного обогащения словаря рекомендуется использовать **итеративный процесс**, который автоматически повторяет цикл до тех пор, пока все значения не будут переведены:

```bash
python scripts/iterative_translation_enrichment.py
```

**Процесс работы:**
1. Нормализует все объявления (где `is_processed = false`)
2. Анализирует непереведенные значения
3. Извлекает непереведенные значения в JSON файл
4. **Ожидает ручного добавления переводов** (отредактируйте `translations_to_add.json`)
5. Добавляет переводы в словарь
6. Сбрасывает `is_processed = false` для повторной нормализации
7. Повторяет цикл до тех пор, пока не останется непереведенных значений

**Параметры:**
- `--max-iterations` - Максимальное количество итераций (по умолчанию: 10)
- `--translations-file` - Путь к файлу с переводами (по умолчанию: `translations_to_add.json`)
- `--min-count` - Минимальное количество вхождений для извлечения (по умолчанию: 1)
- `--auto-add` - Автоматически добавлять переводы из файла (без ожидания)
- `--no-wait` - Не ждать ручного добавления переводов между итерациями

**Пример использования:**
```bash
# Полный автоматический цикл (если переводы уже добавлены в файл)
python scripts/iterative_translation_enrichment.py --auto-add --no-wait

# С ожиданием ручного добавления переводов между итерациями
python scripts/iterative_translation_enrichment.py
```

## Скрипты

### 0. `iterative_translation_enrichment.py` (Оркестратор итеративного процесса)

**Рекомендуемый способ** для полного обогащения словаря. Автоматически выполняет весь цикл обогащения до тех пор, пока все значения не будут переведены.

**Использование:**
```bash
python scripts/iterative_translation_enrichment.py
```

**Процесс работы:**
1. Нормализует все объявления (`is_processed = false`)
2. Анализирует непереведенные значения
3. Извлекает непереведенные значения в JSON
4. Ожидает ручного добавления переводов (если не указан `--auto-add`)
5. Добавляет переводы в словарь
6. Сбрасывает `is_processed = false` для повторной нормализации
7. Повторяет цикл до тех пор, пока не останется непереведенных значений

**Параметры:**
- `--max-iterations` - Максимальное количество итераций (по умолчанию: 10)
- `--translations-file` - Путь к файлу с переводами (по умолчанию: `translations_to_add.json`)
- `--min-count` - Минимальное количество вхождений для извлечения (по умолчанию: 1)
- `--auto-add` - Автоматически добавлять переводы из файла (без ожидания)
- `--no-wait` - Не ждать ручного добавления переводов между итерациями

### 1. `extract_translations.py`

Извлекает все непереведенные китайские значения из нормализованных данных (`processed_data`) и сохраняет их в структурированный JSON файл.

**Использование:**
```bash
python scripts/extract_translations.py --output translations_to_add.json --min-count 1
```

**Параметры:**
- `--output` - Путь к выходному JSON файлу (по умолчанию: `translations_to_add.json`)
- `--min-count` - Минимальное количество вхождений для включения (по умолчанию: 1)

**Выходной формат:**
```json
{
  "metadata": {
    "extracted_at": "2026-02-09T12:00:00",
    "total_records_analyzed": 1000,
    "total_untranslated_unique": 500,
    "already_in_dict_count": 100,
    "new_translations_count": 400,
    "min_count_threshold": 1
  },
  "translations_by_field": {
    "mark": {
      "大通": {
        "count": 150,
        "priority": "high"
      }
    },
    "options": {
      "车联网": {
        "count": 1200,
        "priority": "high"
      }
    }
  },
  "summary_by_priority": {
    "high": 50,
    "medium": 200,
    "low": 150
  }
}
```

### 2. `add_translations.py`

Добавляет переводы из JSON файла в словарь `app/utils/translator.py`.

**Использование:**
```bash
python scripts/add_translations.py translations_to_add.json
```

**Параметры:**
- `json_file` - Путь к JSON файлу с переводами (обязательный)
- `--dry-run` - Режим проверки без добавления переводов

**Формат входного файла:**

**Вариант 1: Структурированный формат (из extract_translations.py)**
```json
{
  "translations_by_field": {
    "mark": {
      "大通": {"translation": "Maxus"}
    },
    "options": {
      "车联网": {"translation": "Интернет в автомобиле"}
    }
  }
}
```

**Вариант 2: Простой формат**
```json
{
  "大通": "Maxus",
  "智界": "Zhijie",
  "车联网": "Интернет в автомобиле"
}
```

**Что делает скрипт:**
- Валидирует записи переводов
- Проверяет на дубликаты (если перевод уже есть в словаре)
- Добавляет новые переводы в `TRANSLATIONS_CN_RU` словарь
- Сохраняет обновленный файл `translator.py`

### 3. `retranslate.py`

Повторно нормализует записи с китайскими символами используя обновленный словарь переводов.

**Использование:**
```bash
python scripts/retranslate.py --fields mark model options --limit 1000 --batch-size 200
```

**Параметры:**
- `--fields` - Список полей для обновления (по умолчанию: все поля)
- `--limit` - Максимальное количество записей для обработки (по умолчанию: без ограничений)
- `--batch-size` - Размер батча для обработки (по умолчанию: 200)

**Что делает скрипт:**
- Находит все записи в `processed_data` с китайскими символами
- Получает соответствующие записи из `raw_data`
- Нормализует их заново с обновленным словарем
- Обновляет поля в `processed_data`

### 4. `analyze_untranslated.py`

Анализирует нормализованные данные и выводит статистику по непереведенным значениям.

**Использование:**
```bash
python scripts/analyze_untranslated.py
```

**Что делает скрипт:**
- Анализирует все записи в `processed_data`
- Находит непереведенные китайские тексты
- Группирует по полям и частоте использования
- Сохраняет результаты в `untranslated_analysis.txt`

### 5. `enrich_translations.py` (Оркестратор)

Автоматизирует весь процесс обогащения словаря переводов.

**Использование:**
```bash
# Только извлечение
python scripts/enrich_translations.py

# Полный цикл с автоматическим добавлением и повторной нормализацией
python scripts/enrich_translations.py --auto-add --auto-retranslate

# Режим проверки
python scripts/enrich_translations.py --auto-add --dry-run
```

**Параметры:**
- `--translations-file` - Путь к файлу с переводами (по умолчанию: `translations_to_add.json`)
- `--min-count` - Минимальное количество вхождений для извлечения (по умолчанию: 1)
- `--auto-add` - Автоматически добавлять переводы из файла
- `--auto-retranslate` - Автоматически запускать повторную нормализацию
- `--dry-run` - Режим проверки без изменений

**Процесс работы:**
1. Извлекает непереведенные значения → `translations_to_add.json`
2. (Опционально) Добавляет переводы из файла в словарь
3. (Опционально) Запускает повторную нормализацию данных
4. Анализирует результаты

## Рекомендуемый рабочий процесс

### Шаг 1: Извлечение непереведенных значений

```bash
python scripts/extract_translations.py --output translations_to_add.json --min-count 5
```

Это создаст файл `translations_to_add.json` со всеми непереведенными значениями, отсортированными по приоритету и частоте использования.

### Шаг 2: Добавление переводов

Отредактируйте файл `translations_to_add.json` и добавьте переводы в формате:
```json
{
  "translations_by_field": {
    "mark": {
      "大通": {"translation": "Maxus"}
    }
  }
}
```

Или используйте простой формат:
```json
{
  "大通": "Maxus",
  "智界": "Zhijie"
}
```

### Шаг 3: Проверка перед добавлением

```bash
python scripts/add_translations.py translations_to_add.json --dry-run
```

Это покажет, сколько переводов будет добавлено, без изменения файлов.

### Шаг 4: Добавление переводов в словарь

```bash
python scripts/add_translations.py translations_to_add.json
```

### Шаг 5: Повторная нормализация данных

```bash
python scripts/retranslate.py --batch-size 200
```

Это обновит все записи с китайскими символами используя новый словарь.

### Шаг 6: Проверка результатов

```bash
python scripts/analyze_untranslated.py
```

Это покажет, сколько непереведенных значений осталось.

## Автоматизация всего процесса

Для автоматизации всего процесса используйте оркестратор:

```bash
# 1. Извлечение
python scripts/enrich_translations.py

# 2. Добавьте переводы в translations_to_add.json вручную

# 3. Добавление и повторная нормализация
python scripts/enrich_translations.py --auto-add --auto-retranslate
```

## Приоритеты переводов

Скрипты автоматически определяют приоритет перевода:

- **Высокий приоритет**: Марки, модели, опции, типы двигателей/КПП (частота >= 10)
- **Средний приоритет**: Адреса, секции, другие часто используемые значения (частота >= 10)
- **Низкий приоритет**: Редко используемые значения, длинные описания

## Примечания

- Все скрипты работают с базой данных через SQLAlchemy
- Изменения в словаре переводов требуют перезапуска приложения для применения
- Рекомендуется делать резервную копию БД перед повторной нормализацией
- Процесс повторной нормализации может занять время для больших объемов данных
