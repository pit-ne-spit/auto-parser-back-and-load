# Улучшения модуля нормализации данных

## Дата: 2026-02-09

## Выполненные улучшения

### 1. Добавлены новые поля в модель ProcessedData

Добавлены поля для информации о продавце и дате создания объявления:

- **`seller_type`** (String, nullable, indexed) - Тип продавца (dealer/private)
- **`is_dealer`** (Boolean, nullable) - Флаг дилера
- **`salon_id`** (String, nullable) - ID салона
- **`offer_created`** (Date, nullable) - Дата создания объявления

**Миграция:** `67daed722540_add_seller_fields_to_processed_data.py`

### 2. Обновлен нормализатор для извлечения новых полей

Модуль `DataNormalizer` теперь извлекает и нормализует следующие поля:

- **seller_type** - извлекается как есть из `raw_data.data.seller_type`
- **is_dealer** - преобразуется из строки в boolean:
  - `"true"`, `"1"`, `"yes"` → `True`
  - Остальные значения → `False`
- **salon_id** - извлекается как есть из `raw_data.data.salon_id`
- **offer_created** - парсится из строки в формат date:
  - Поддерживает форматы: `"YYYY-MM-DD"` и `"YYYY-MM"` (добавляется день "01")

### 3. Улучшена обработка ошибок

**До:** При ошибке в одной записи откатывался весь батч (200 записей).

**После:** При ошибке в отдельной записи:
- Ошибка логируется с указанием `inner_id`
- Запись пропускается
- Остальные записи в батче продолжают обрабатываться
- Запись остается с `is_processed = False` для повторной обработки

**Преимущества:**
- Более устойчивая обработка данных
- Ошибки в отдельных записях не блокируют обработку всего батча
- Лучшая производительность при наличии проблемных записей

### 4. Добавлена валидация данных

Добавлен метод `_validate_normalized_data()` для проверки данных перед сохранением:

**Проверки:**
- Наличие обязательных полей (`inner_id`)
- Валидность года (1900 - текущий год + 1)
- Валидность цены (0 - 100,000,000 юаней)
- Валидность пробега (0 - 10,000,000 км)
- Валидность мощности (0 - 10,000 л.с.)
- Валидность объема двигателя (0 - 20 литров)

**Поведение:**
- При невалидных данных запись пропускается
- Ошибка логируется с указанием причины
- Запись остается с `is_processed = False` для исправления

## Использование

### Применение миграции

```bash
alembic upgrade head
```

### Запуск нормализации

```bash
# Нормализация всех необработанных записей
python scripts/normalize.py

# С кастомным размером батча
python scripts/normalize.py --batch-size 100

# С ограничением количества записей (для тестирования)
python scripts/normalize.py --limit 1000
```

## Статистика обработки

Модуль теперь возвращает более детальную статистику:
- `total_processed` - количество успешно обработанных записей
- `total_created` - количество созданных записей в processed_data
- `total_updated` - количество обновленных записей в processed_data
- `total_errors` - количество ошибок (включая валидационные ошибки)
- `total_batches` - количество обработанных батчей

## Логирование

Все операции логируются в `logs/app.log`:
- Успешная обработка записей
- Ошибки нормализации с указанием `inner_id`
- Валидационные ошибки с указанием причины
- Пропущенные записи

## Обратная совместимость

Все изменения обратно совместимы:
- Существующие записи в `processed_data` не затрагиваются
- Новые поля имеют значение `NULL` для старых записей
- Можно безопасно применять миграцию на существующей БД

## Рекомендации

1. **Применение миграции:** Рекомендуется применить миграцию перед запуском нормализации новых данных
2. **Повторная нормализация:** Для обновления существующих записей можно сбросить флаг `is_processed`:
   ```sql
   UPDATE raw_data SET is_processed = false WHERE inner_id IN (...);
   ```
3. **Мониторинг:** Следить за логами на наличие валидационных ошибок и проблемных записей
