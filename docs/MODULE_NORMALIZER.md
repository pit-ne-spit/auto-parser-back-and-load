# Модуль нормализации данных

## Описание

Модуль `DataNormalizer` предназначен для нормализации сырых данных из таблицы `raw_data` и преобразования их в структурированный формат в таблице `processed_data`. Этот модуль извлекает ключевые поля из JSON, преобразует типы данных, переводит текстовые поля и создает нормализованные записи.

## Расположение

- **Класс:** `app.normalizers.data_normalizer.DataNormalizer`
- **Скрипт запуска:** `scripts/normalize.py`
- **Базовый класс:** `app.normalizers.base_normalizer.BaseNormalizer`

## Логика работы

### 1. Инициализация

```python
normalizer = DataNormalizer(batch_size=200)
```

**Параметры:**
- `batch_size` (Optional[int]): Размер батча для обработки. По умолчанию 200 записей. Можно переопределить через аргумент `--batch-size` или конфигурацию.

### 2. Определение записей для обработки

1. Выполняется запрос к таблице `raw_data`:
   - Выбираются записи где `is_processed = False`
   - Подсчитывается общее количество таких записей

2. Если записей нет, процесс завершается

3. Если указан `limit`, обрабатывается только указанное количество записей (для тестирования)

### 3. Обработка батчами

#### Шаг 1: Получение батча

1. Выполняется запрос к `raw_data`:
   - `WHERE is_processed = False`
   - `ORDER BY id`
   - `LIMIT batch_size`
   - `OFFSET offset`

2. Если записей нет, процесс завершается

#### Шаг 2: Обработка записей в батче

Для каждой записи в батче выполняется нормализация:

1. **Нормализация данных:**
   - Вызывается метод `_normalize_record(raw_record.data)`
   - Извлекаются и преобразуются все необходимые поля
   - Возвращается словарь с нормализованными полями

2. **Проверка существования в processed_data:**
   - Ищется запись по `inner_id` в таблице `processed_data`

3. **Создание или обновление:**
   - **Если запись существует:**
     - Обновляются все поля из нормализованного словаря
     - Обновляется `active_status` из `raw_data`
     - Обновляется `updated_at` = текущее время UTC
   - **Если запись не существует:**
     - Создается новая запись со всеми полями
     - Устанавливается `active_status` из `raw_data`
     - Устанавливается `created_at` из `raw_data`

4. **Пометка как обработанной:**
   - Устанавливается `raw_record.is_processed = True`

#### Шаг 3: Коммит транзакции

1. **Транзакционность:**
   - Весь батч обрабатывается в одной транзакции
   - Если возникает ошибка при обработке любой записи в батче:
     - Выполняется rollback всей транзакции
     - Все записи батча остаются с `is_processed = False`
     - Ошибка логируется
     - Процесс продолжается со следующего батча

2. **При успешной обработке:**
   - Выполняется commit транзакции
   - Все записи батча помечаются как обработанные (`is_processed = True`)
   - Обновляется статистика

### 4. Нормализация записи (_normalize_record)

Метод извлекает и преобразует данные из JSON `raw_data.data`:

#### Базовые поля из блока data

1. **URL:**
   - `url` - URL объявления

2. **Марка и модель:**
   - `mark` - марка автомобиля (переводится через `translate_field`)
   - `model` - модель автомобиля (переводится через `translate_field`)

3. **Год:**
   - `year` - год выпуска
   - Преобразуется из строки в int (удаляются нецифровые символы)

4. **Цвет:**
   - `color` - цвет автомобиля (переводится через `translate_field`)

5. **Цена:**
   - `price` - цена автомобиля
   - Преобразуется из строки в int (удаляются нецифровые символы)

6. **Пробег:**
   - `km_age` - пробег автомобиля
   - Преобразуется из строки в int (удаляются нецифровые символы)

7. **Технические характеристики:**
   - `engine_type` - тип двигателя (переводится)
   - `transmission_type` - тип КПП (переводится)
   - `body_type` - тип кузова (переводится)
   - `displacement` - объем двигателя (преобразуется в float)
   - `power` - мощность (преобразуется в int)
   - `drive_type` - тип привода (переводится)

8. **Адрес и продавец:**
   - `address` - адрес (переводится)
   - `section` - секция (б/у или новый) (переводится)

9. **Дополнительная информация:**
   - `description` - описание (переводится)
   - `vin` - VIN номер
   - `first_registration` - дата первой регистрации (парсится в date)
   - `images` - массив изображений (парсится из JSON строки или массива)

#### Опции из extra.option

1. Извлекаются опции из `extra.option.displayopts`:
   - Перебираются все опции
   - Извлекается `optionname` для каждой опции
   - Переводится через `translate_field`
   - Добавляется в список `options`

2. Извлекаются опции из `extra.option.moreoptions`:
   - Перебираются группы опций
   - Из каждой группы извлекаются опции
   - Переводится `optionname`
   - Добавляется в список `options`

3. Результат сохраняется в поле `options` как массив строк

#### Параметры конфигурации

1. Извлекаются параметры из `configuration.paramtypeitems`:
   - Перебираются типы параметров
   - Из каждого типа извлекаются параметры (`paramitems`)
   - Проверяется `id` параметра на соответствие списку важных ID:
     ```
     {93, 91, 90, 88, 116, 101, 108, 92, 115, 97, 95, 38, 58, 3, 13, 6, 11, 14, 17, 20, 24, 23, 41, 40, 42, 46, 43, 44, 47, 48, 49, 50, 53}
     ```

2. Для каждого найденного параметра сохраняется:
   - `id` - идентификатор параметра (как строка)
   - `name` - название параметра
   - `value` - значение параметра

3. Результат сохраняется в поле `configuration` как словарь:
   ```json
   {
     "93": {"name": "...", "value": "..."},
     "91": {"name": "...", "value": "..."}
   }
   ```

4. Вся конфигурация переводится через `translate_field` перед извлечением параметров

### 5. Перевод полей (translate_field)

Используется модуль `app.utils.translator` для перевода китайских текстовых полей в русский язык:
- Марки и модели автомобилей
- Цвета
- Типы двигателя, КПП, кузова
- Адреса
- Описания
- Опции
- Параметры конфигурации

### 6. Обработка ошибок

1. **Ошибки при нормализации записи:**
   - Логируются с указанием `inner_id`
   - Вызывается `raise` для отката всего батча
   - Все записи батча остаются необработанными

2. **Ошибки при коммите:**
   - Выполняется rollback
   - Ошибка логируется
   - Процесс продолжается со следующего батча

3. **Ошибки при обработке батча:**
   - Весь батч откатывается
   - Все записи остаются с `is_processed = False`
   - Ошибка логируется
   - Процесс продолжается

### 7. Отображение прогресса

Используется класс `ProgressBar` для отображения прогресса в консоли:
```
[INFO] Normalization: 45.2% (90,400 / 200,000 records) | Speed: 500 records/min | ETA: 3h 25m
```

### 8. Завершение работы

1. **Запись в operations_log:**
   - `operation_type` = "normalization"
   - `started_at` - время начала операции
   - `duration` - продолжительность в секундах
   - `status` - "OK" или "ERROR" (если были ошибки)
   - `details` - информация об ошибках (если были)

2. **Статистика:**
   - `total_processed` - количество обработанных записей
   - `total_created` - количество созданных записей в processed_data
   - `total_updated` - количество обновленных записей в processed_data
   - `total_errors` - количество ошибок (батчей с ошибками)
   - `total_batches` - количество обработанных батчей

## Использование

### Базовый запуск

```bash
python scripts/normalize.py
```

Обрабатывает все необработанные записи из `raw_data`.

### С кастомным размером батча

```bash
python scripts/normalize.py --batch-size 100
```

Обрабатывает батчами по 100 записей.

### С ограничением количества записей (для тестирования)

```bash
python scripts/normalize.py --limit 1000
```

Обрабатывает только первые 1000 необработанных записей.

### Комбинированный запуск

```bash
python scripts/normalize.py --batch-size 100 --limit 5000
```

Обрабатывает максимум 5000 записей батчами по 100.

## Особенности реализации

### Транзакционность

- Весь батч обрабатывается в одной транзакции
- При ошибке в любой записи батча откатывается весь батч
- Это гарантирует целостность данных
- Записи остаются с `is_processed = False` для повторной обработки

### Продолжение после прерывания

- Модуль можно прервать (Ctrl+C) и запустить заново
- Записи с `is_processed = False` будут обработаны заново
- Это позволяет безопасно перезапускать процесс

### Преобразование типов

1. **Числовые поля:**
   - Удаляются все нецифровые символы из строк
   - Преобразуются в соответствующие типы (int или float)

2. **Даты:**
   - Парсятся из строк формата "YYYY-MM" или "YYYY-MM-DD"
   - Преобразуются в объекты `date`

3. **JSON строки:**
   - Парсятся из строк в объекты Python
   - Обрабатываются ошибки парсинга

### Перевод полей

- Используется модуль `translator` для перевода китайских текстов
- Переводится вся текстовая информация:
  - Марки, модели, цвета
  - Технические характеристики
  - Адреса и описания
  - Опции и параметры конфигурации

### Извлечение опций

- Опции извлекаются из двух источников:
  - `displayopts` - основные опции
  - `moreoptions` - дополнительные опции
- Удаляются дубликаты опций
- Все опции переводятся на русский язык

### Извлечение параметров конфигурации

- Извлекаются только важные параметры по списку ID
- Сохраняется структура: `id → {name, value}`
- Вся конфигурация переводится перед извлечением

## Зависимости

- `BaseNormalizer` - базовый класс с общей логикой
- `RawData` - модель сырых данных
- `ProcessedData` - модель нормализованных данных
- `AsyncSessionLocal` - сессия базы данных
- `ProgressBar` - класс для отображения прогресса
- `translate_field` - функция перевода полей
- `config` - конфигурация проекта
- `logger` - система логирования

## Логирование

Все операции логируются в `logs/app.log`:
- Начало и завершение операции
- Прогресс нормализации
- Ошибки с указанием `inner_id`
- Статистика по батчам
- Статистика завершения

## Статистика

Модуль возвращает статистику:
- `total_processed` - количество обработанных записей
- `total_created` - количество созданных записей в processed_data
- `total_updated` - количество обновленных записей в processed_data
- `total_errors` - количество ошибок (батчей с ошибками)
- `total_batches` - количество обработанных батчей

## Пример вывода

```
[INFO] Found 200,000 unprocessed records to normalize
[INFO] Normalization: 10.0% (20,000 / 200,000 records) | Speed: 500 records/min | ETA: 6h 0m
[INFO] Normalization: 20.0% (40,000 / 200,000 records) | Speed: 510 records/min | ETA: 5h 13m
...
[INFO] Normalization completed: processed=200000, created=150000, updated=50000, errors=0, batches=1000
```

## Рекомендации по использованию

1. **Запуск после обновления данных:**
   - Запускать после завершения `daily_update.py`
   - Это обеспечит нормализацию всех новых и измененных записей

2. **Размер батча:**
   - По умолчанию 200 записей - оптимальный баланс между производительностью и надежностью
   - Можно уменьшить при проблемах с памятью
   - Можно увеличить для ускорения (но увеличивается риск ошибок)

3. **Мониторинг:**
   - Следить за прогрессом в логах
   - Проверять статистику в таблице `operations_log`
   - Обращать внимание на ошибки в логах

4. **Обработка ошибок:**
   - При ошибках записи остаются с `is_processed = False`
   - Можно перезапустить модуль для повторной обработки
   - Рекомендуется проверить логи для выявления проблемных записей

5. **Производительность:**
   - Для больших объемов данных процесс может занять несколько часов
   - Рекомендуется запускать в фоновом режиме или через Cron
   - Можно использовать `--limit` для тестирования на небольшом объеме
