# Обзор проекта

## Назначение проекта

Проект предназначен для парсинга объявлений о продаже автомобилей с китайской площадки CHE168.COM через API. Система состоит из трех основных модулей:

1. **Единоразовое скачивание** - первоначальная загрузка всех объявлений (~250,000 записей)
2. **Ежедневное обновление** - получение изменений за предыдущий день (~15,000 записей)
3. **Нормализация** - преобразование сырых данных в структурированный формат

## Архитектура

### База данных

Проект использует PostgreSQL с двумя основными таблицами:

- **`raw_data`** - хранит сырые данные из API в формате JSONB
- **`processed_data`** - хранит нормализованные структурированные данные

### Процесс работы

```
API CHE168.COM
    ↓
[Единоразовое скачивание] → raw_data (is_processed = false)
    ↓
[Нормализация] → processed_data
    ↓
[Ежедневное обновление] → raw_data (is_processed = false)
    ↓
[Нормализация] → processed_data (обновление)
    ↓
[Публичное API] → отдача данных из processed_data
```

## Основные модули

### 1. Модуль единоразового скачивания

**Файл:** `app/loaders/initial_loader.py`  
**Скрипт:** `scripts/initial_load.py`  
**Документация:** [MODULE_INITIAL_LOADER.md](MODULE_INITIAL_LOADER.md)

Загружает все объявления из API через эндпоинт `/offers` с пагинацией. Сохраняет данные в таблицу `raw_data` с пометкой `is_processed = false` для последующей нормализации.

**Особенности:**
- Пагинация по страницам (20 записей на страницу)
- Rate limiting (0.7 сек между запросами)
- Обработка дубликатов
- Продолжение после прерывания

### 2. Модуль ежедневного обновления

**Файл:** `app/loaders/daily_updater.py`  
**Скрипт:** `scripts/daily_update.py`  
**Документация:** [MODULE_DAILY_UPDATER.md](MODULE_DAILY_UPDATER.md)

Получает изменения за предыдущий день через эндпоинты `/change_id` и `/changes`. Обрабатывает три типа изменений:
- `added` - новые объявления
- `changed` - измененные объявления (merge JSON данных)
- `removed` - удаленные объявления (помечаются как неактивные)

**Особенности:**
- Автоматическое определение обработанных дат
- Merge JSON данных с маппингом полей `new_*`
- Обновление состояния синхронизации (`sync_state`)

### 3. Модуль нормализации

**Файл:** `app/normalizers/data_normalizer.py`  
**Скрипт:** `scripts/normalize.py`  
**Документация:** [MODULE_NORMALIZER.md](MODULE_NORMALIZER.md)

Преобразует сырые данные из `raw_data` в структурированный формат в `processed_data`. Извлекает ключевые поля, преобразует типы данных, переводит текстовые поля с китайского на русский.

**Особенности:**
- Батчевая обработка (200 записей по умолчанию)
- Транзакционность (откат всего батча при ошибке)
- Перевод полей через модуль translator
- Извлечение опций и параметров конфигурации

## Структура базы данных

### Таблица: raw_data

Сырые данные из API:
- `inner_id` - уникальный ID объявления на платформе
- `change_type` - тип изменения (added/changed/removed)
- `data` - полные данные в формате JSONB
- `source` - источник данных (initial_load/daily_update)
- `active_status` - статус (0 - активное, 1 - неактивное)
- `is_processed` - флаг обработки нормализатором

### Таблица: processed_data

Нормализованные данные:
- `inner_id` - связь с raw_data
- Базовые поля: mark, model, year, price, km_age, color
- Технические характеристики: engine_type, transmission_type, body_type, displacement, power
- Дополнительные поля: address, description, vin, images, options, configuration
- `active_status` - статус объявления

### Дополнительные таблицы

- `sync_state` - состояние синхронизации (последняя обработанная дата)
- `operations_log` - логи операций (загрузка, нормализация)
- `api_tokens` - токены для доступа к публичному API

## Запуск модулей

### Первоначальная загрузка

```bash
# Полная загрузка
python scripts/initial_load.py

# Тестовая загрузка (10 страниц)
python scripts/initial_load.py --max-pages 10
```

### Ежедневное обновление

```bash
# Обновление за вчерашний день
python scripts/daily_update.py

# Тестовое обновление
python scripts/daily_update.py --max-dates 1
```

### Нормализация

```bash
# Нормализация всех необработанных записей
python scripts/normalize.py

# С кастомным размером батча
python scripts/normalize.py --batch-size 100

# С ограничением количества записей
python scripts/normalize.py --limit 1000
```

## Конфигурация

### Переменные окружения (.env)

```env
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=пароль
DB_NAME=che168_db
CHE168_API_KEY=api_ключ
CHE168_ACCESS_NAME=autobase
```

### Конфигурационный файл (config.yaml)

Содержит технические настройки:
- Логирование (уровни, ротация, retention)
- Размеры батчей
- Retry настройки (20 попыток, 12 минут интервал)
- Таймауты API
- Rate limiting

## Логирование

Все операции логируются в `logs/app.log`:
- Уровни: DEBUG, INFO, WARNING, ERROR
- Ротация: 10 MB, 5 backup файлов
- Retention: 7 дней
- Формат: `[LEVEL] message`

## Мониторинг

### Таблица operations_log

Хранит информацию о всех операциях:
- Тип операции (data_fetch/normalization)
- Время начала и продолжительность
- Статус (OK/ERROR)
- Детали ошибок

### Прогресс-бары

Модули выводят прогресс в консоль:
- Процент выполнения
- Количество обработанных записей
- Скорость обработки
- ETA (estimated time of arrival)

## Развертывание

### Локальная разработка

1. Установить PostgreSQL локально
2. Создать базу данных
3. Применить миграции: `alembic upgrade head`
4. Настроить `.env`
5. Запустить модули

### Production (VPS)

1. Реплицировать БД с локальной машины на VPS
2. Настроить Docker контейнеры
3. Настроить Cron для ежедневных задач:
   - 02:00 - ежедневное обновление
   - 03:00 - нормализация данных
4. Запустить API сервер

## Документация модулей

Подробная документация по каждому модулю:

- [Модуль единоразового скачивания](MODULE_INITIAL_LOADER.md)
- [Модуль ежедневного обновления](MODULE_DAILY_UPDATER.md)
- [Модуль нормализации](MODULE_NORMALIZER.md)

## Временные файлы

Список временных файлов, которые можно удалить:
- [Анализ временных файлов](TEMP_FILES_ANALYSIS.md)

## Статус проекта

Текущий статус реализации:
- ✅ Инфраструктура проекта
- ✅ База данных и миграции
- ✅ Утилиты и вспомогательные модули
- ✅ Модуль загрузки данных (единоразовое скачивание)
- ✅ Модуль ежедневного обновления
- ✅ Модуль нормализации данных
- ⏳ Публичное API (в разработке)
- ⏳ Docker и развертывание

Подробнее см. [TASKS.md](../TASKS.md)
